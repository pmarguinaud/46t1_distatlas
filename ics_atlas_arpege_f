#!/bin/bash

#
export GMK_THREADS=16
#
type gmkpack >/dev/null 2>&1
if [ $? -ne 0 ] ; then
  echo "error : gmkpack could not be found."
  exit 1
else
  export GMKROOT=$(dirname $(dirname $(which gmkpack | awk '{print $NF}')))
fi
. $GMKROOT/aux/wrkpack.sh
#
# ------ Main settings --------------------------------------
#
# Fortran compiler options :
# optfrt[4] = Optimal, as for operations : -O2 -fast-transcendentals     -finline-functions -finline-limit=500 -Winline 
# optfrt[3] = Debugging                  : -fp-model source -fp-model precise -g -traceback -O0 -debug full
# optfrt[2] = Debugging + Bound checking : -fp-model source -fp-model precise -g -traceback -O0 -debug full -check bounds
# optfrt[1] = Preinitialisations to NaN  : -fp-stack-check -ftrapuv -fpe0 -fp-speculation=strict -check uninit -init=arrays,snan
# optfrt[0] = User-defined options
optfrt[0]=""
#
# Choose subscript (0/1/2/3) :
# --------------------------
Ofrt=4
#
# C compiler options :
optvcc="-O2 -fast-transcendentals     -finline-functions -finline-limit=500 -Winline "
#
#
# Files in pack to ignore (obsolete/useless) :
# ------------------------------------------  
cat <<end_of_ignored_files> $GMKWRKDIR/.ignored_files
end_of_ignored_files
#
# Do you want to compile dependencies ? (yes/no)
# -----------------------------------
export DEP=yes
# If you compile dependencies, approve the following projects list :
export MKPROJECT="aeolus aladin algor arpifs biper blacklist coupling crm ecfftw etrans ifsaux ifsobs mpa mse obstat odb radiation satrad scat scripts surf surfex trans utilities validation"
#
# Supplementary projects with autogenerated explicit interface blocks :
# -------------------------------------------------------------------  
export INTFB_PROJLIST=""
#
# Do you want to enable the recursive update control ? (yes/no) ?
# --------------------------------------------------
export ICS_RECURSIVE_UPDATE=yes
#
# Do you want to postpone the aborts on compilation errors to the end of the compilation step ? (yes/no) ?
# -------------------------------------------------------------------------------------------
export ICS_POSTPONE_ABORT=no
#
# Three compilation modes are possible : 
# full = full compilation (default value)
# incr = incremental compilation (from a starting to an ending level)
# off  = No compilation at all
# Choose compilation mode (full/incr/off) : 
# ---------------------------------------
export ICS_ICFMODE=full
# If you use the incremental compilation facility, select the top and bottom levels :
export ICS_START=
export ICS_STOP=
# Reduced starting list :
cat <<end_of_reduced_starting_list> $GMKWRKDIR/.reduced_starting_list
end_of_reduced_starting_list
#
# Do you want to output the compilation listings ? (yes/no)
# ----------------------------------------------
export ICS_LIST=yes
#
# Compilation timing report:
# ------------------------- 
# ICS_TIMING_REPORT = 0 (No report) = N (N most time consuming files)
export ICS_TIMING_REPORT=0
#
# Norms checker 2011 severity :
# ---------------------------  
# ICS_NC_SEVERITY = 0 (No report) or 1 (Severe,Warning) or 2 (+Informative)
# ICS_NC_SUPPRESS = "section.item:section.item" : suppressed messages
export ICS_NC_SEVERITY=2
export ICS_NC_SUPPRESS=""
export WHITELIST=
export GEN_WHITELIST=0
#
# Do you want to output the load map(s) ? (yes/no)
# -------------------------------------
export ICS_MAP=no
#
# Five libraries update are possible : 
# full  = full update (default value)
# user  = update user libraries only, not the dummy ones
# dummy = update dummy (user-mirror) libraries only, not the user ones
# unsx  = update unsatisfied external libraries only, not the user/dummy ones
# off   = no update at all
# Choose the libraries update mode (full/user/dummy/unsx/off) : 
# --------------------------------
export ICS_UPDLIBS=full
#
#
# ODB Maximum number of updates supported at compile time
odb_nmxupd=10
#
#
# Do you want to make any executable ? (yes/no)
# ----------------------------------
Load=yes
#
# If you want to make any executable, approve the following ones :
# (libraries should be properly ordered from top to bottom for each binary)
#
# Binary "atlas_arpege_f" :
cat <<end_of_atlas_arpege_f_link> $GMKWRKDIR/.atlas_arpege_f_link
EXEC=ATLAS_ARPEGE_F
ENTRY=atlas/programs/atlas-arpege_f.o
end_of_atlas_arpege_f_link
# BACKGROUND LIBRARIES (from top to bottom) :
cat <<end_of_atlas_arpege_f_libs> $GMKWRKDIR/.atlas_arpege_f_libs
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libmse.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libmse.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-mse.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libarpifs.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libarpifs.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libaladin.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libaladin.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-aladin.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libtrans.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-trans.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-etrans.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libetrans.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-etrans.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libbiper.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libalgor.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libifsaux.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-ifsaux.inter.1.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libifsaux.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libprograms-ifsaux.main.a
/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x/lib/libunsxref-verbose.main.a
end_of_atlas_arpege_f_libs
# LOW-LEVEL LIBRARIES (from top to bottom) :
cat <<end_of_atlas_arpege_f_sys> $GMKWRKDIR/.atlas_arpege_f_sys
-L/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/x2.9 -lgribex
-L/home/gmap/mrpm/marguina/atlas/install/lib -latlas_f -latlas -leckit_linalg -leckit_maths -leckit_mpi -leckit_option -leckit -leckit_web -lfckit
-L/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/netcdf-4.7.2/lib -lnetcdff -lnetcdf
-L/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/eccodes-2.14.0/lib -leccodes_f90 -leccodes 
-L/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/x2.9 -libmdummy
-L/opt/softs/intel/2018.04/compilers_and_libraries_2018.5.274/linux/tbb/lib/intel64_lin/gcc4.7 -ltbbmalloc_proxy -ltbbmalloc
-lstdc++
end_of_atlas_arpege_f_sys
# LOADER AND OPTIONS :
cat <<end_of_atlas_arpege_f_load> $GMKWRKDIR/.atlas_arpege_f_load
/home/gmap/mrpm/marguina/benchmf1709/gmkpack_support/wrapper/INTELMPI185274/mpif90 /home/gmap/mrpm/marguina/benchmf1709/gmkpack_support/wrapper/I185274/ifort -mkl=sequential -v -fp-stack-check -qopenmp -qopenmp-threadprivate=compat -shared-intel -lifcoremt -lifport -fimf-use-svml=true -Wl,-rpath,/opt/softs/intel/beta/mkl_nightly_2019u2_20181208/mkl/lib/intel64 -Wl,-rpath,/opt/softs/intel/2018.04/compilers_and_libraries_2018.5.274/linux/tbb/lib/intel64_lin/gcc4.7 -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/boost_1_72_0/lib -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/eccodes-2.14.0/lib -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/hdf5-1.10.5/lib -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/lapack-3.2.1/lib -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/netcdf-4.7.2/lib -Wl,-rpath,/home/gmap/mrpm/marguina/install/I185274INTELMPI185274_bull/x2.9 -Wl,-rpath,/home/gmap/mrpm/marguina/atlas/install/lib
end_of_atlas_arpege_f_load
#
#
# Blacklist file generator
# ------------------------

export ICS_BL_GENERATOR=


# Verboose level (0 or 1 or 2 or 3) :
# --------------

export ICS_ECHO=1


export MAINPACK=
export TARGET_PACK=/home/gmap/mrpm/marguina/pack/46t1_distatlas.01.I185274INTELMPI185274.x
export GMKVIEW="main inter.1 local"
# ----------------------------------------------------------------------------------
# ----------------------------------------------------------------------------------
#
#
# ------ Environment variables -----------------------------------------------------
#
$GMKROOT/aux/envvarpack.sh > $GMKWRKDIR/environment_variables
if [ $? -eq 0 ] ; then
  chmod 755 $GMKWRKDIR/environment_variables
  . $GMKWRKDIR/environment_variables
  \rm $GMKWRKDIR/environment_variables 
else
  echo "Error in envvarpack.sh :"
  cat $GMKWRKDIR/gmkpack_env_variables
  \rm -rf $GMKWRKDIR
  exit 1
fi
#
#
# IF YOU WISH TO CHANGE ANY VARIABLE FROM THE CONFIGURATION FILE
# YOU SHOULD DO IT RIGHT BELOW THIS LINE !
#
#
#
$GMKROOT/aux/privarpack.sh > $GMKWRKDIR/environment_variables
chmod 755 $GMKWRKDIR/environment_variables
. $GMKWRKDIR/environment_variables
\rm $GMKWRKDIR/environment_variables
optfrt[4]="$OPT_FRTFLAGS" 
optfrt[3]="$DBG_FRTFLAGS"
optfrt[2]="$DBG_FRTFLAGS $BCD_FRTFLAGS"
optfrt[1]="$OPT_FRTFLAGS $NAN_FRTFLAGS"
export MyF90Flags="${optfrt[$Ofrt]}"
export MyF77Flags="${optfrt[$Ofrt]}"
export MyVccFlags="$optvcc"
#
export ODB_NMXUPD=$odb_nmxupd
#
#
# Who am I ? Where do I go ?
# --------------------------
echo
echo "This is $(basename $(grep ^THIS_GMKPACK $GMKROOT/util/gmkpack | awk -F"/" '{print $(NF-2)}')) running on a script made by gmkpack.6.7.2"
#
echo
$GMKROOT/aux/catenvpack.sh
#
# Compilation :
# -----------
$GMKROOT/aux/mkcplpack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit
fi
#
# Libraries :
# ---------
$GMKROOT/aux/libspack.sh
if [ $? -ne 0 ] ; then
  echo
  echo Finished on $(date)
  exit
fi
#
# Binaries :
# --------
if [ "$Load" = "yes" ] ; then
  $GMKROOT/aux/lnkpack.sh
fi
#
#
echo
\rm -rf $GMKWRKDIR
echo Finished on $(date)
